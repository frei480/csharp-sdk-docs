

Руководство по T-FLEX CAD Open API

# Создание элемента управления VariableControl   
```csharp
using System;
using System.Windows.Forms;

using TFlex;
using TFlex.Model;
using TFlex.Model.Model2D;
using TFlex.Model.Model3D;
using TFlex.Command;

namespace NewMacroNamespace
{
	public class GrooveCommand : CustomCommand
	{
		public GrooveCommand(TFlex.Command.CommandState cmd)
			: base(cmd)
		{

		}

		TFlex.Model.Document _document;
		TFlex.Model.Model2D.Fragment fragment;

		public override void OnInitialize(InitializeEventArgs e)
		{
			_document = TFlex.Application.ActiveDocument;
			_document.BeginChanges("");

			base.OnInitialize(e);

			UpdateAutomenu();
		}

		public override void OnExit(ExitEventArgs e)
		{
			_document.EndChanges();
		}

		public void InsertGroove(TFlex.Command.CommandState cmd)
		{
			try
			{
				CustomCommand d = new GrooveCommand(cmd);
				d.Run(null);
			}
			catch (Exception e)
			{
				MessageBox.Show(e.StackTrace);
			}
		}

		public InputState State { get; set; }

		public enum InputState
		{
			None,//Ничего не выбрано
			Fragment,//вставка фрагмента
			FragVars,//вызов окна свойств
		};

		public override void OnKeyPressed(TFlex.Command.KeyEventArgs e)
		{
			_document = e.Document;
			switch (e.Code)
			{
				case KeyCode.keyEND:
					{
						State = InputState.Fragment;

						string pathFragment = "<Винты невыпадающие>Винт ГОСТ 10336-80.grb";

						fragment = new Fragment(_document, pathFragment);
						FixingVector fv = new FixingVector(_document); //вектор привязки
						//fv.Name = "FixingVector";

						FreeNode fn1 = new FreeNode(_document, 10, 160);
						FreeNode fn2 = new FreeNode(_document, 100, 160);

						fv.StartNode = fn1;
						fv.EndNode = fn2;
						fv.Color = 200;
						//установить привязку фрагмента по вектору привязки с указанным именем
						fragment.SetFixingVectorName("FixingVector");

						_document.ApplyChanges();
						UpdateAutomenu();
					}
					break;

				case (KeyCode.keyF):
					{
						State = InputState.FragVars;
						CreatePropertiesWindow();
						UpdateAutomenu();
					}
					break;

				case KeyCode.keyESCAPE:
					{
						State = InputState.None;
						GoToNextState(null);
						OnExit(null);
					}
					break;
			}
		}

		private PropertiesWindowForm _propertiesControlForm;

		protected void UpdateAutomenu()
		{
			TFlex.Command.Button[] buttonsAutonenu = new TFlex.Command.Button[3];
			buttonsAutonenu[0] = new DefaultButton(DefaultButton.Kind.OK, KeyCode.keyEND,
				State == InputState.Fragment ? TFlex.Command.Button.Style.Checked : TFlex.Command.Button.Style.Default);

			buttonsAutonenu[1] = new CustomButton(2, KeyCode.keyF, "", State == InputState.FragVars ? TFlex.Command.Button.Style.Checked : TFlex.Command.Button.Style.Default);          
			buttonsAutonenu[2] = new DefaultButton(State == InputState.None ? DefaultButton.Kind.Exit : DefaultButton.Kind.Cancel);

			Automenu = new Automenu(buttonsAutonenu);
		}

		protected void CreatePropertiesWindow()
		{
			//Инициализируем диалог свойств
			//В нём 2 закладки
			PropertiesWindow propertiesWindow = new PropertiesWindow();
			propertiesWindow.Caption = "Свойства фрагмента";
			VariablesControl control1 = new VariablesControl();//this, _document);
			control1.Visible = true;
			control1.Fragment = fragment;
| control1.Anchor = AnchorStyles.Top | AnchorStyles.Right | AnchorStyles.Left; |

			PropertiesWindowForm form1 = new PropertiesWindowForm(control1);
			form1.Caption = "Основные свойства";
			form1.AutoSize = true;
			this._propertiesControlForm = form1;
			propertiesWindow.AppendForm(form1);

			//Тип заголовка в окне свойств
			propertiesWindow.PropertiesHeaderType = PropertiesWindow.HeaderType.OkPreviewCancel;

			propertiesWindow.EnableHeaderButton(PropertiesWindowHeaderButton.OK, false);
			propertiesWindow.EnableHeaderButton(PropertiesWindowHeaderButton.Preview, false);

			this.PropertiesWindow = propertiesWindow;
		}
	};

	public class NewMacroClass
	{
		public static void NewMacro()
		{
			TFlex.Command.CommandState cmd = new TFlex.Command.CommandState();

			GrooveCommand c = new GrooveCommand(cmd);//.InsertGroove(null);
			c.InsertGroove(cmd);
		}
	}

}
    ```