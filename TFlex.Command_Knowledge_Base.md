# База знаний по классам в пространстве имён TFlex.Command

## Plugin

**Описание:** Базовый класс для создания расширений (плагинов) T-Flex CAD.

**Основные методы:**
- `OnInitialize()`: инициализация плагина при загрузке
- `OnCreateTools()`: создание команд, меню, интерфейса
- `OnCommand(Document, int)`: обработка команд
- `DocumentOpenEventHandler(DocumentEventArgs)`: обработка открытия документов
- `NewDocumentCreatedEventHandler(DocumentEventArgs)`: обработка создания документов

**Регистрация команд:**
- `RegisterCommand(int id, string name, Icon smallIcon, Icon largeIcon)`: регистрация команды
- `RegisterObjectTypeIcon(int typeId, Icon icon)`: регистрация иконки типа объекта

**Использование:** Наследование для создания пользовательских плагинов.

## Application

**Описание:** Предоставляет доступ к глобальным функциям приложения T-Flex CAD.

**Основные свойства:**
- `ActiveDocument`: Document - текущий активный документ
- `Version`: Version - версия приложения

**Основные методы:**
- `OpenDocument(string path)`: открытие документа
- `GetCustomLicenseStatus(int licenseId)`: проверка лицензии
- `InitializeCustomLicense(int licenseId)`: инициализация лицензии

**События:**
- `ApplicationStarted`: запуск приложения
- `ApplicationClosing`: закрытие приложения

**Использование:** Для взаимодействия с приложением на глобальном уровне.

## Menu

**Описание:** Класс для создания меню и контекстных меню.

**Основные методы:**
- `CreatePopup()`: создание всплывающего меню
- `Append(int cmdId, string text, Plugin plugin)`: добавление команды
- `AppendSeparator()`: добавление разделителя
- `AppendSubMenu(string text, Menu subMenu)`: добавление подменю

**Использование:** Для создания меню команд плагина.

## MainWindow

**Описание:** Предоставляет доступ к главному окну приложения.

**Основные методы:**
- `InsertPluginSubMenu(string name, Menu menu, InsertMenuPosition position, Plugin plugin)`: вставка меню плагина

**Перечисление InsertMenuPosition:**
- `BeginningOfTools`: начало раздела инструментов
- `EndOfTools`: конец раздела инструментов
- `BeginningOfFile`: начало раздела файл
- `EndOfFile`: конец раздела файл

**Использование:** Для интеграции меню плагина в интерфейс.

## DocumentEventArgs

**Описание:** Аргументы событий связанных с документами.

**Основные свойства:**
- `Document`: Document - документ, вызвавший событие

**Использование:** В обработчиках событий открытия/создания документов.

## LibraryConfigurations

**Описание:** Коллекция конфигураций библиотек элементов.

**Основные свойства:**
- `Active`: LibraryConfiguration - активная библиотека
- `Count`: int - количество библиотек

**Основные методы:**
- `Open(string path)`: открытие библиотеки
- `GetEnumerator()`: перечислитель для перебора библиотек

**Использование:** Для управления библиотеками элементов в T-Flex.

## LibraryConfiguration

**Описание:** Конфигурация отдельной библиотеки элементов.

**Основные свойства:**
- `Name`: string - имя библиотеки
- `Path`: string - путь к файлу библиотеки
- `IsActive`: bool - активна ли библиотека

**Основные методы:**
- `Activate()`: активация библиотеки
- `Close()`: закрытие библиотеки

**Использование:** Для работы с конкретной библиотекой элементов.

## Дополнительная информация

### Архитектура плагина
1. **Наследование от Plugin**: основной класс плагина
2. **OnInitialize()**: проверка лицензии, загрузка ресурсов
3. **OnCreateTools()**: регистрация команд, создание UI
4. **OnCommand()**: обработка выполнения команд
5. **Обработчики событий**: реакция на события документов

### Регистрация команд
- Команды идентифицируются по int ID
- ID должны быть уникальными в рамках плагина
- Иконки: маленькие (16x16) и большие (32x32)

### Жизненный цикл плагина
```
Загрузка DLL → Конструктор → OnInitialize() → OnCreateTools()
                                      ↓
Документы: DocumentOpenEventHandler() / NewDocumentCreatedEventHandler()
                                      ↓
Команды: OnCommand() → Выполнение команд
                                      ↓
Выгрузка: Очистка ресурсов
```

### Интеграция с интерфейсом
- **Меню**: через MainWindow.InsertPluginSubMenu()
- **Лента**: через RibbonTab и RibbonGroup
- **Панели**: через создание кастомных форм
- **Контекстные меню**: через Menu с привязкой к объектам

### Лицензирование
- Проверка: `Application.GetCustomLicenseStatus(id)`
- Инициализация: `Application.InitializeCustomLicense(id)`
- ID лицензии: уникальный номер для каждого плагина

### Обработка ошибок
- Проверять существование документов
- Обрабатывать исключения в OnCommand()
- Показывать понятные сообщения пользователю
- Логировать ошибки для отладки

### Производительность
- Минимизировать работу в OnInitialize()
- Кэшировать ресурсы (иконки, настройки)
- Использовать lazy loading для тяжелых компонентов
- Отписываться от событий при выгрузке

### Совместимость версий
- Проверять Version перед использованием новых API
- Использовать try-catch для потенциально нестабильных вызовов
- Предоставлять fallback для старых версий

### Безопасность
- Проверять пути к файлам
- Валидировать входные данные
- Использовать безопасные вызовы API
- Избегать выполнения внешнего кода

### Отладка плагинов
- Использовать OutputDebugString для логов
- Обрабатывать исключения с подробностями
- Тестировать на разных версиях T-Flex
- Проверять работу с разными типами документов</content>
<parameter name="filePath">d:\work\T-Flex\macros\Source\TFlex.Command_Knowledge_Base.md